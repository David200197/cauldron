#!/bin/bash

# Copy for release
cd `dirname $0`/..

if [ ! -f ChangeLog ]; then
	echo Cannot extract information from ChangeLog, as it does not exist.
	exit
fi

target=`head -n1 ChangeLog | cut -f1 -d' '`
version=`head -n1 ChangeLog | cut -f2 -d'(' | cut -f1 -d')'`

cd ..
if [ -d ${target}-${version} ]; then
	echo The directory ${target}-${version} already exists. Remove it first.
	exit
fi

rsync -avq ${target}/ ${target}-${version} --exclude 'resources/*' --exclude 'files/default_maps/*' --exclude 'files/default_tokes/*'
cd ${target}-${version}

# Empty logfiles
for file in access actions database debug error poll search spam; do
	if [ -f logfiles/${file}.log ]; then
		chmod 646 logfiles/${file}.log
		echo -n "" > logfiles/${file}.log
	fi
done

# Enable setup module
cat settings/public_modules.conf | sed 's/#setup/setup/' > modules.conf
mv modules.conf settings/public_modules.conf

# Change settings
function change_setting {
	cat settings/website.conf | sed "s/${1}.*/${1} = ${2}/" > website.conf
	mv website.conf settings/website.conf
}

change_setting DB_HOSTNAME localhost
change_setting DB_DATABASE cauldron
change_setting DB_USERNAME cauldron
change_setting DB_PASSWORD cauldron
change_setting DEBUG_MODE yes

# Remove files
rm -f database/*.gz
rm -f ws_server module layout
rm -rf templates

# Make package
#cd ..
#tar -czf ${target}-${version}.tar.gz ${target}-${version}
#rm -rf ${target}-${version}
echo "../${target}-${version} created."
